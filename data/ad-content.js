// Dữ liệu nội dung quảng cáo
export const adContent = {
  header: {
    title: 'Mua sắm Shopee',
    product: 'Kính mắt thời trang',
    description: 'Khám phá ngàn ưu đãi hấp dẫn',
    cta: 'Mua ngay',
    icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
    link: 'https://s.shopee.vn/gFEWr4DF0'
  },
  content: {
    title: 'Flash Sale',
    product: 'Kính mắt thời trang',
    description: 'Giảm đến 90%',
    cta: 'Xem ngay',
    icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997400/kinh_j3e0kn.webp',
    link: 'https://s.shopee.vn/gFEWr4DF0'
  },
  sidebar: {
    title: 'Ưu đãi đặc biệt',
    product: 'Kính mắt thời trang',
    description: 'Miễn phí vận chuyển',
    cta: 'Khám phá',
    icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
    link: 'https://s.shopee.vn/gFEWr4DF0'
  },
  footer: {
    title: 'Shopee - Mua sắm online',
    product: 'Kính mắt thời trang',
    description: 'Hàng triệu sản phẩm, giá tốt nhất',
    cta: 'Truy cập ngay',
    icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
    link: 'https://s.shopee.vn/gFEWr4DF0'
  }
};

// Danh sách các biến thể quảng cáo
export const adVariants = [
  {
    id: 1,
    name: 'Kính mắt thời trang',
    header: {
      title: 'Mua sắm Shopee',
      product: 'Kính mắt thời trang',
      description: 'Khám phá ngàn ưu đãi hấp dẫn',
      cta: 'Mua ngay',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997400/kinh_j3e0kn.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    content: {
      title: 'Flash Sale',
      product: 'Kính mắt thời trang',
      description: 'Giảm đến 90%',
      cta: 'Xem ngay',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997400/kinh_j3e0kn.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    sidebar: {
      title: 'Ưu đãi đặc biệt',
      product: 'Kính mắt thời trang',
      description: 'Miễn phí vận chuyển',
      cta: 'Khám phá',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    footer: {
      title: 'Shopee - Mua sắm online',
      product: 'Kính mắt thời trang',
      description: 'Hàng triệu sản phẩm, giá tốt nhất',
      cta: 'Truy cập ngay',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    }
  },
  {
    id: 2,
    name: 'Kính mắt nam',
    header: {
      title: 'Shopee Fashion',
      product: 'Kính mắt nam cao cấp',
      description: 'Phong cách đàn ông hiện đại',
      cta: 'Khám phá',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997400/kinh_j3e0kn.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    content: {
      title: 'Hot Sale',
      product: 'Kính mắt nam cao cấp',
      description: 'Giảm giá sốc 70%',
      cta: 'Mua ngay',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997400/kinh_j3e0kn.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    sidebar: {
      title: 'Thời trang nam',
      product: 'Kính mắt nam cao cấp',
      description: 'Chất lượng đảm bảo',
      cta: 'Xem thêm',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    footer: {
      title: 'Shopee - Thời trang nam',
      product: 'Kính mắt nam cao cấp',
      description: 'Phong cách đàn ông thành đạt',
      cta: 'Truy cập',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    }
  },
  {
    id: 3,
    name: 'Kính mắt nữ',
    header: {
      title: 'Shopee Beauty',
      product: 'Kính mắt nữ thời trang',
      description: 'Làm đẹp mỗi ngày',
      cta: 'Mua sắm',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    content: {
      title: 'Beauty Sale',
      product: 'Kính mắt nữ thời trang',
      description: 'Giảm đến 80%',
      cta: 'Xem ngay',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997400/kinh_j3e0kn.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    sidebar: {
      title: 'Làm đẹp',
      product: 'Kính mắt nữ thời trang',
      description: 'Tặng kèm khăn lau',
      cta: 'Khám phá',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    },
    footer: {
      title: 'Shopee - Làm đẹp',
      product: 'Kính mắt nữ thời trang',
      description: 'Nâng tầm vẻ đẹp của bạn',
      cta: 'Truy cập ngay',
      icon: 'https://res.cloudinary.com/diwxfpt92/image/upload/v1752997383/kinh_hcgygs.webp',
      link: 'https://s.shopee.vn/gFEWr4DF0'
    }
  }
];

// Lưu lịch sử ad variant đã hiển thị trong localStorage
function getRecentAdVariants() {
  const recent = JSON.parse(localStorage.getItem('ad_recent_variants') || '[]');
  const now = Date.now();
  // Lọc bỏ các variant cũ hơn 5 phút (300000ms)
  const filtered = recent.filter(item => now - item.timestamp < 300000);
  if (filtered.length !== recent.length) {
    localStorage.setItem('ad_recent_variants', JSON.stringify(filtered));
  }
  return filtered;
}

function saveRecentAdVariant(variantId) {
  const recent = getRecentAdVariants();
  recent.push({
    id: variantId,
    timestamp: Date.now()
  });
  localStorage.setItem('ad_recent_variants', JSON.stringify(recent));
}

// Hàm lấy nội dung quảng cáo random không lặp lại trong 5 phút
export function getRandomAdContent() {
  const recentVariants = getRecentAdVariants();
  const recentIds = recentVariants.map(item => item.id);
  const availableVariants = adVariants.filter(variant => !recentIds.includes(variant.id));
  let chosen;
  if (availableVariants.length === 0) {
    // Nếu tất cả đã hiển thị, reset lịch sử và random lại
    localStorage.removeItem('ad_recent_variants');
    chosen = adVariants[Math.floor(Math.random() * adVariants.length)];
  } else {
    chosen = availableVariants[Math.floor(Math.random() * availableVariants.length)];
  }
  saveRecentAdVariant(chosen.id);
  return chosen;
}

// Hàm lấy nội dung quảng cáo theo ID
export function getAdContentById(id) {
  return adVariants.find(variant => variant.id === id) || adVariants[0];
}

// Hàm lấy link affiliate từ nội dung quảng cáo
export function getAdAffiliateLink() {
  const randomAd = getRandomAdContent();
  return randomAd.header.link; // Lấy link từ header làm mặc định
}

// Hàm lấy biến thể quảng cáo hiện tại (ưu tiên localStorage, hợp lệ trong 5 phút)
function getCurrentAdVariant() {
  const current = JSON.parse(localStorage.getItem('ad_current_variant') || 'null');
  const now = Date.now();
  if (current && now - current.timestamp < 300000) {
    const variant = adVariants.find(v => v.id === current.id);
    if (variant) return variant;
  }
  return null;
}

// Hàm random và lưu lại biến thể quảng cáo hiện tại
function pickAndSaveAdVariant() {
  const variant = getRandomAdContent();
  localStorage.setItem('ad_current_variant', JSON.stringify({id: variant.id, timestamp: Date.now()}));
  return variant;
}

// Hàm cập nhật nội dung quảng cáo
export function updateAdContent(forceNew = false) {
  let ad;
  if (forceNew) {
    ad = pickAndSaveAdVariant();
  } else {
    ad = getCurrentAdVariant();
    if (!ad) ad = pickAndSaveAdVariant();
  }
  // Cập nhật header
  const headerTitle = document.querySelector('.ad-shopee-title');
  const headerProduct = document.querySelector('.ad-shopee-product');
  const headerDesc = document.querySelector('.ad-shopee-desc');
  const headerCta = document.querySelector('.ad-shopee-cta');
  const headerBanner = document.querySelector('.ad-shopee');
  const headerIcon = document.querySelector('.ad-shopee-icon');
  if (headerTitle) headerTitle.textContent = ad.header.title;
  if (headerProduct) headerProduct.textContent = ad.header.product;
  if (headerDesc) headerDesc.textContent = ad.header.description;
  if (headerCta) headerCta.textContent = ad.header.cta;
  if (headerBanner) headerBanner.href = ad.header.link;
  if (headerIcon) headerIcon.innerHTML = `<img src="${ad.header.icon}" alt="Shopee" class="ad-icon-img">`;
  // Cập nhật content
  const contentTitle = document.querySelector('.ad-shopee-square-title');
  const contentProduct = document.querySelector('.ad-shopee-square-product');
  const contentDesc = document.querySelector('.ad-shopee-square-desc');
  const contentCta = document.querySelector('.ad-shopee-square-cta');
  const contentBanner = document.querySelector('.ad-shopee-square');
  const contentIcon = document.querySelector('.ad-shopee-square-icon');
  if (contentTitle) contentTitle.textContent = ad.content.title;
  if (contentProduct) contentProduct.textContent = ad.content.product;
  if (contentDesc) contentDesc.textContent = ad.content.description;
  if (contentCta) contentCta.textContent = ad.content.cta;
  if (contentBanner) contentBanner.href = ad.content.link;
  if (contentIcon) contentIcon.innerHTML = `<img src="${ad.content.icon}" alt="Shopee" class="ad-icon-img">`;
  // Cập nhật sidebar
  const sidebarTitle = document.querySelector('.ad-shopee-sidebar-title');
  const sidebarProduct = document.querySelector('.ad-shopee-sidebar-product');
  const sidebarDesc = document.querySelector('.ad-shopee-sidebar-desc');
  const sidebarCta = document.querySelector('.ad-shopee-sidebar-cta');
  const sidebarBanner = document.querySelector('.ad-shopee-sidebar');
  const sidebarIcon = document.querySelector('.ad-shopee-sidebar-icon');
  if (sidebarTitle) sidebarTitle.textContent = ad.sidebar.title;
  if (sidebarProduct) sidebarProduct.textContent = ad.sidebar.product;
  if (sidebarDesc) sidebarDesc.textContent = ad.sidebar.description;
  if (sidebarCta) sidebarCta.textContent = ad.sidebar.cta;
  if (sidebarBanner) sidebarBanner.href = ad.sidebar.link;
  if (sidebarIcon) sidebarIcon.innerHTML = `<img src="${ad.sidebar.icon}" alt="Shopee" class="ad-icon-img">`;
  // Cập nhật footer
  const footerTitle = document.querySelector('.ad-shopee-footer-title');
  const footerProduct = document.querySelector('.ad-shopee-footer-product');
  const footerDesc = document.querySelector('.ad-shopee-footer-desc');
  const footerCta = document.querySelector('.ad-shopee-footer-cta');
  const footerBanner = document.querySelector('.ad-shopee-footer');
  const footerIcon = document.querySelector('.ad-shopee-footer-icon');
  if (footerTitle) footerTitle.textContent = ad.footer.title;
  if (footerProduct) footerProduct.textContent = ad.footer.product;
  if (footerDesc) footerDesc.textContent = ad.footer.description;
  if (footerCta) footerCta.textContent = ad.footer.cta;
  if (footerBanner) footerBanner.href = ad.footer.link;
  if (footerIcon) footerIcon.innerHTML = `<img src="${ad.footer.icon}" alt="Shopee" class="ad-icon-img">`;
} 